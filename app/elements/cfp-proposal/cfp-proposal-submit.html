<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../styles/app-theme.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="cfp-proposal-submit">
  <style is="custom-style" include="shared-styles">
  </style>
  <template>
    <firebase-document id="fbPropDoc" path="/conference/[[conferenceId]]" data="{{_conference}}"></firebase-document>
    <h2>[[_conference.name]]</h2>
    <p><i>[[_conference.topics]]</i></p>
    <h3>Submit Proposal</h3>
    <div id="container">
      <paper-input required label="Title" value="{{_proposal.title}}"></paper-input>
      <paper-dropdown-menu required label="Duration">
        <paper-listbox class="dropdown-content" selected="{{_proposal.duration}}">
          <template is="dom-repeat" items="[[_confDurations(_conference)]]" as="duration">
            <paper-item>[[duration]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <paper-textarea required rows="3" label="Abstract" value="{{_proposal.abstract}}"></paper-textarea>
      <paper-textarea rows="2" label="Comment" value="{{_proposal.comment}}"></paper-textarea>
      <paper-button raised on-tap="_submit">Submit</paper-button>
      <paper-button raised on-tap="_cancel">Cancel</paper-button>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'cfp-proposal-submit',

        properties: {
          conferenceId: {
            type: String,
            notify: true
          },
          userId: {
            type: String,
            notify: true
          },
          fireApp: {
            type: Object,
            notify: true,
            value: {}
          },
          _proposal: {
            type: Object,
            notify: true,
            value: {}
          },
          _conference: {
            type: Object,
            notify: true
          }
        },
        _confDurations: function(conference) {
          if (conference && conference.durations) {
            var keys = Object.keys(conference.durations).sort();
            var durations = [];
            for (var i=0; i < keys.length; i++) {
              durations[i] = conference.durations[keys[i]];
            }
            return durations;
          }
        },
        _submit: function() {
          // add the user id if needed
          if (!this._proposal.speaker) {
            this._proposal.speaker = this.userId;
          }
          // save the proposal
          this.fireApp.database().ref('/proposal/' + this.conferenceId + '/' + this.userId).push(this._proposal);
          // reset form
          this._proposal = {};
          this.fire('proposal-submit', {changed: true, message: 'Proposal submitted'});
        },
        _cancel: function() {
          this.fire('proposal-submit', {changed: false, message: 'Proposal not submitted'});
        }
      });
    })();
  </script>
</dom-module>
