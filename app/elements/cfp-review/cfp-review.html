<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-shared-styles.html">

<dom-module id="cfp-review">
  <style is="custom-style" include="paper-dialog-shared-styles">
    .review-abstract div {
      padding-left: 20px;
      padding-right: 20px;
    }
    paper-fab.icon-unselected {
      --paper-fab-background: var(--google-grey-500);
    };
  </style>
  <template>
    <firebase-document path="/review/[[conferenceId]]/[[userId]]/[[speakerId]]/[[proposalId]]" data="{{_reviewDoc}}"></firebase-document>
    <firebase-document path="/proposal/[[conferenceId]]/[[speakerId]]/[[proposalId]]" data="{{_proposalDoc}}"></firebase-document>
    <h2>[[_proposalDoc.title]]</h2>
    <paper-dialog-scrollable class="review-abstract">
      <div>[[_proposalDoc.abstract]]</div>
      <div class="proposal-comment">[[_proposalDoc.comment]]</div>
    </paper-dialog-scrollable>
    <paper-input label="Comment" value="{{_comment}}"></paper-input>
    <div class="buttons" on-tap="_saveRating">
      <paper-fab hidden$="[[_equals(_rating, -2)]]" data-rating="-2" icon="image:exposure-neg-2" class="icon-unselected"></paper-fab>
      <paper-fab hidden$="[[!_equals(_rating, -2)]]" data-rating="-2" icon="image:exposure-neg-2"></paper-fab>
      <paper-fab hidden$="[[_equals(_rating, -1)]]" data-rating="-1" icon="image:exposure-neg-1" class="icon-unselected"></paper-fab>
      <paper-fab hidden$="[[!_equals(_rating, -1)]]" data-rating="-1" icon="image:exposure-neg-1"></paper-fab>
      <paper-fab hidden$="[[_equals(_rating, 0)]]" data-rating="0" icon="image:exposure-zero" class="icon-unselected"></paper-fab>
      <paper-fab hidden$="[[!_equals(_rating, 0)]]" data-rating="0" icon="image:exposure-zero"></paper-fab>
      <paper-fab hidden$="[[_equals(_rating, 1)]]" data-rating="1" icon="image:exposure-plus-1" class="icon-unselected"></paper-fab>
      <paper-fab hidden$="[[!_equals(_rating, 1)]]" data-rating="1" icon="image:exposure-plus-1"></paper-fab>
      <paper-fab hidden$="[[_equals(_rating, 2)]]" data-rating="2" icon="image:exposure-plus-2" class="icon-unselected"></paper-fab>
      <paper-fab hidden$="[[!_equals(_rating, 2)]]" data-rating="2" icon="image:exposure-plus-2"></paper-fab>
      <paper-button raised dialog-dismiss>Cancel</paper-button>
    </div>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'cfp-review',
        behaviors: [
          Polymer.PaperDialogBehavior
        ],
        properties: {
          conferenceId: {
            type: String,
            notify: true
          },
          fireApp: {
            type: Object,
            notify: true,
            value: {}
          },
          userId: {
            type: String,
            notify: true
          },
          speakerId: {
            type: String,
            notify: true
          },
          proposalId: {
            type: String,
            notify: true
          },
          _proposalDoc: {
            type: Object,
            notify: true
          },
          _reviewDoc: {
            type: Object,
            notify: true,
          },
          _rating: {
            type: Number,
            notify: true,
            value: 0
          },
          _comment: {
            type: String,
            notify: true
          }
        },
        _saveRating: function(e) {
          var f = Polymer.dom(e);
          if (f && f.localTarget && f.localTarget.dataset) {
            if (typeof f.localTarget.dataset.rating !== "undefined") {
              var dialog = this;
              var comment = dialog._comment;
              var rating = f.localTarget.dataset.rating;
              var path = '/review/' + dialog.conferenceId +
                   '/' + dialog.userId + '/' + dialog.speakerId +
                   '/' + dialog.proposalId;
              console.log("Path: ");
              console.log(path);
              console.log("Comment:");
              console.log(comment);
              console.log("Rating: ");
              console.log(rating);
              dialog.fireApp.database()
              .ref(path)
              .set({
                comment: comment,
                rating: rating
              })
              .then(function() {
                dialog.close();
                dialog.fire("reviewed", {proposalId: dialog.proposalId});
              });
            }
          }
        },
        openForm(speakerId, proposalId) {
          var that = this;
          var path = '/review/' + this.conferenceId +
               '/' + this.userId + '/' + speakerId +
               '/' + proposalId;
          this.set('speakerId', speakerId);
          this.set('proposalId', proposalId);
          this.fireApp.database()
            .ref(path)
            .once("value", function(data) {
              console.log("Firebase data...");
              console.log(data.val());
              that.set('_rating', data.val().rating);
              that.set('_comment', data.val().comment);
              that.open();
            }, function(err) {
              console.log("Error in FB");
              console.log(err);
            });
        },
        _equals: function(x, y) {
          return x == y;
        }
      });
    })();
  </script>
</dom-module>
 
