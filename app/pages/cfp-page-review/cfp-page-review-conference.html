<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="cfp-page-review-conference">
  <style is="custom-style" include="shared-styles iron-flex iron-flex-alignment">
    paper-material {
      @apply(--paper-font-body2);
    };
    div.proposals {
      @apply(--layout-flex);
      @apply(--layout-wrap);
      @apply(--layout-horizontal);
    };
    div.proposals paper-material {
      width: 480px;
      height: 360px;
      overflow: hidden;
    };
    div.proposals table th {
      text-align: left;
      vertical-align: top;
    };
    div.proposals table td {
      text-align: left;
      vertical-align: top;
    };
    paper-fab.fab-grey {
      --paper-fab-background: var(--google-grey-500);
    };
  </style>
  <template>
    <firebase-document path="/review/[[conferenceId]]/[[userId]]" data="{{_reviewDoc}}"></firebase-document>
    <firebase-document id="confReviewPropFb" path="/proposal/[[conferenceId]]" data="{{_proposalDoc}}"></firebase-document>
    <p hidden$="[[_hasAccess]]">You don't have access</p>
    <div hidden$="[[_hasAccess]]">
      <paper-input label="Access Key for Reviews" value="{{_accessKey}}"></paper-input>
      <br>
      <paper-button raised on-tap="_writeKey">Submit</paper-button>
    </div>
    <paper-toggle-button hidden$="[[!_hasAccess]]" active="{{_filterNewOnly}}">New Items only</paper-toggle-button>
    <div hidden$="[[!_hasAccess]]" class="proposals">
      <template id="reviews" is="dom-repeat" items="[[_proposalsMerged]]" as="proposal" filter="[[_computeFilter(_filterNewOnly)]]">
        <paper-material elevation="1">
          <h2>[[proposal.title]]</h2>
          <!-- show rating -->
          <paper-fab style="float:right;" class$="[[_ratingClass(proposal)]]" icon="[[_ratingIcon(proposal)]]" title="Rate"></paper-fab>
          <p>[[proposal.review.comment]]</p>
          <p>[[proposal.abstract]]</p>
        </paper-material>
      </template>
    </div>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'cfp-page-review-conference',
        properties: {
          conferenceId: {
            type: String,
            notify: true
          },
          fireApp: {
            type: Object,
            notify: true,
            value: {}
          },
          userId: {
            type: String,
            notify: true
          },
          _proposalDoc: {
            type: Object,
            notify: true
          },
          _reviewDoc: {
            type: Object,
            notify: true
          },
          _hasAccess: {
            type: Boolean,
            computed: "_isNotNull(_proposals)",
            notify: true
          },
          _proposals: {
            type: Array,
            computed: "_flattenTwoDim(_proposalDoc)",
            notify: true
          },
          _proposalsMerged: {
            type: Array,
            computed: "_mergePropsReviews(_proposals, _reviewDoc)",
            notify: true
          },
          _accessKey: {
            type: String,
            notify: true
          },
          _filterNewOnly: {
            type: Boolean,
            notify: true
          }
        },
        _isNotNull: function(x) {
          return x && x.length > 0;
        },
        _flattenTwoDim: function(all) {
          console.log("flatten...");
          console.log(all);
          var flat = [];
          var i = 0;
          var a, b;
          for (a in all) {
            if (all[a] instanceof Object) {
              for (b in all[a]) {
                if (all[a][b] instanceof Object) {
                  flat[i] = {
                    title: all[a][b].title,
                    abstract: all[a][b].abstract,
                    duration: all[a][b].duration,
                    comment: all[a][b].comment,
                    id: b
                  };
                  i++;
                }
              }
            }
          }
          flat.sort(function(x,y) {
            return x.title < y.title ? -1
               : (x.title == y.title ? 0: 1);
          })
          console.log(flat);
          return flat;
        },
        _mergePropsReviews: function(proposals, reviews) {
          var i = 0;
          var l = proposals.length;
          var key;
          for (i=0; i<l; i++) {
            key = proposals[i].id;
            if (key in reviews) {
              proposals[i].review = {
                rating: reviews[key].rating,
                comment: reviews[key].comment
              };
            }
          }
          console.log(JSON.stringify(proposals));
          return proposals;
        },
        _writeKey: function() {
          var fbDoc = this.$.confReviewPropFb;
          var confId = this.conferenceId;
          fbDoc.set("path", "/proposal/undefined");
          this.fireApp.database()
          .ref('/profile/' + this.userId + '/secret/' + confId)
          .set(this._accessKey)
          .then(function() {
            fbDoc.set("path", "/proposal/" + confId);
          });
        },
        _ratingIcon: function(p) {
          console.log(JSON.stringify(p));
          if (!p.review) {
            console.log("no review");
            return "create";
          }
          console.log("has review!");
          switch (p.review.rating) {
            case -1:
            return "image:exposure-neg-1";
            case -2:
            return "image:exposure-neg-2";
            case 1:
            return "image:exposure-plus-1";
            case 2:
            return "image:exposure-plus-2";
            case 0:
            default:
            return "image:exposure-zero"
          }
        },
        _ratingClass: function(p) {
          if (!p.review) {
            return "fab-normal";
          }
          return "fab-grey";
        },
        _computeFilter: function(flag) {
          if (flag) {
            return function(p) {
              return !p.review;
            }
          }
          else {
            return null;
          }
        }
      });
    })();
  </script>
</dom-module>
 
